<style>
  span {
    width: 150px;
  }
  .button {
    border: 1px solid gray;
    color: white;
    padding: 8px 15px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 12px;
  }
  .button:hover {
    cursor: pointer;
  }
  .start {background-color: #4CAF50;}
  .pause {background-color: #008CBA;}
  .stop {background-color: #f44336;}
  .reset {background-color: #ec971f;}
</style>

<div id="template" style="display:none;">
  <span>Clock no</span>
  <div id="clock-no" class="clock" data-id="no">
    <div class="values">00:00:00</div>
    <div>
      <button data-id="no" data-key="kkey-start" class="start button startButton">Start</button>
      <button data-id="no" data-key="kkey-pause" class="pause button pauseButton" >Pause</button>
      <button data-id="no" data-key="kkey-stop" class="stop button stopButton">Stop</button>
      <button data-id="no" data-key="kkey-reset" class="reset button resetButton">Reset</button>
      <span>last action show here</span>
    </div>
  </div>
</div>

<div class="add-clock-form">
  <span><label for="key-map-start">Key start</label></span>
  <input type="text" id="key-map-start" placeholder="e.g. q" style="width: 80px;" >
  <br/>
  <span><label for="key-map-pause">Key pause</label></span>
  <input type="text" id="key-map-pause" placeholder="e.g. w" style="width: 80px;" >
  <br/>
  <span><label for="key-map-stop">Key stop</label></span>
  <input type="text" id="key-map-stop" placeholder="e.g. e" style="width: 80px;" >
  <br/>
  <span><label for="key-map-reset">Key reset</label></span>
  <input type="text" id="key-map-reset" placeholder="e.g. r" style="width: 80px;" >
  <small>(all lowercase)</small>
  <button id="add-clock">Add Clock</button>
</div>
<div>
  <button id="start-all-clock">Start All</button>
  <button id="stop-all-clock">Stop All</button>
</div>
<br/>
<br/>
<div id="clock-container">

</div>

<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
<script src="easytimer/dist/easytimer.min.js"></script>

<script>

  var app = {
    template: $('#template').html(),
    container:$('#clock-container'),
    count: 0,
    Timers: [],
    keyMap: [],

    init: function() {
      this.binds();
    },

    binds: function() {
      var that = this;

      $('#start-all-clock').click(function() {
        for(let tt=0; tt<that.Timers.length; tt++){
          let timer = that.Timers[tt];
          timer.start();
          $('#clock-container #clock-'+tt+' span').html('Started by "Start All"');
        }
      });

      $('#stop-all-clock').click(function() {
        for(let tt=0; tt<that.Timers.length; tt++){
          let timer = that.Timers[tt];
          timer.stop();
          $('#clock-container #clock-'+tt+' span').html('Stopped by "Stop All"');
        }
      });

      $('#add-clock').click(function() {
        let keyStart = $('#key-map-start').val();
        if (keyStart == '') {
          alert("Cannot add empty key");
          return false;
        }
        let keyPause = $('#key-map-pause').val();
        if (keyPause == '') {
          alert("Cannot add empty key");
          return false;
        }
        let keyStop = $('#key-map-stop').val();
        if (keyStop == '') {
          alert("Cannot add empty key");
          return false;
        }
        let keyReset = $('#key-map-reset').val();
        if (keyReset == '') {
          alert("Cannot add empty key");
          return false;
        }
        $('#key-map-start').focus();
        $('#key-map-start').val('');
        $('#key-map-pause').val('');
        $('#key-map-stop').val('');
        $('#key-map-reset').val('');

        let loadTemplate = that.template;

        loadTemplate = loadTemplate.replace(/no/g, that.count);
        loadTemplate = loadTemplate.replace(/Start/g, 'Start'+' ('+keyStart+')');
        loadTemplate = loadTemplate.replace(/Pause/g, 'Pause'+' ('+keyPause+')');
        loadTemplate = loadTemplate.replace(/Stop/g, 'Stop'+' ('+keyStop+')');
        loadTemplate = loadTemplate.replace(/Reset/g, 'Reset'+' ('+keyReset+')');
        loadTemplate = loadTemplate.replace(/kkey-start/g, keyStart);
        loadTemplate = loadTemplate.replace(/kkey-pause/g, keyPause);
        loadTemplate = loadTemplate.replace(/kkey-stop/g, keyStop);
        loadTemplate = loadTemplate.replace(/kkey-reset/g, keyReset);

        obb = {
          'startButton': keyStart,
          'pauseButton': keyPause,
          'stopButton': keyStop,
          'resetButton': keyReset
        };


        that.container.append(loadTemplate);
        that.container.append('<br/>');

        that.keyMap[that.count] = obb;

        that.createTimer();
        that.count++;
      });
    },

    createTimer: function() {
      let index = this.count;
      let timer = new Timer();


      $('#clock-container #clock-'+index+' .startButton').click(function () {
          $('#clock-container #clock-'+index+' span').html('started');
          timer.start({precision: 'secondTenths'});
      });
      $('#clock-container #clock-'+index+' .pauseButton').click(function () {
          $('#clock-container #clock-'+index+' span').html('paused');
          timer.pause();
      });
      $('#clock-container #clock-'+index+' .stopButton').click(function () {
          $('#clock-container #clock-'+index+' span').html('stopped');
          timer.stop();
      });
      $('#clock-container #clock-'+index+' .resetButton').click(function () {
          $('#clock-container #clock-'+index+' span').html('resetted');
          timer.reset();
      });
      timer.addEventListener('secondsUpdated', function (e) {
          $('#clock-container #clock-'+index+' .values').html(timer.getTimeValues().toString(['hours', 'minutes', 'seconds']));
      });
      timer.addEventListener('started', function (e) {
          $('#clock-container #clock-'+index+' .values').html(timer.getTimeValues().toString(['hours', 'minutes', 'seconds']));
      });
      timer.addEventListener('reset', function (e) {
          $('#clock-container #clock-'+index+' .values').html(timer.getTimeValues().toString(['hours', 'minutes', 'seconds']));
      });

      this.Timers[index] = timer;

      this.reBindEvent();

    },

    rebindable: function() {
      var that = this;

      $(document).keydown(function(e) {
        console.log(that.keyMap);
        for (let ii=0; ii<that.keyMap.length; ii++) {
          startKey = that.keyMap[ii]['startButton'];
          pauseKey = that.keyMap[ii]['pauseButton'];
          stopKey = that.keyMap[ii]['stopButton'];
          resetKey = that.keyMap[ii]['resetButton'];

          if (e.keyCode == startKey.charCodeAt(0)) {
            $('#clock-container #clock-'+ii+' .startButton').click();
          } else if (e.keyCode == pauseKey.charCodeAt(0)) {
            $('#clock-container #clock-'+ii+' .pauseButton').click();
          } else if (e.keyCode == stopKey.charCodeAt(0)) {
            $('#clock-container #clock-'+ii+' .stopButton').click();
          } else if (e.keyCode == resetKey.charCodeAt(0)) {
            $('#clock-container #clock-'+ii+' .resetButton').click();
          }


          console.log(startKey);
          console.log("XXD");
        }

      });
    },

    reBindEvent: function() {
      $(document).unbind('keydown');

      this.rebindable();
    }

  };

  app.init();
</script>